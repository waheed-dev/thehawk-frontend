# This is a basic workflow to help you get started with Actions

name: Thehawk frontend CD

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
env: 
  MONGODB_URI: ${{secrets.MONGODB_URI}}
  NEXT_PUBLIC_API_ENDPOINT: ${{secrets.NEXT_PUBLIC_API_ENDPOINT}}
  HOST: ${{secrets.HOST}}
  NEXT_PUBLIC_DOMAIN: ${{secrets.NEXT_PUBLIC_DOMAIN}}
  NEXT_PUBLIC_FACEBOOK_APP_ID: ${{secrets.NEXT_PUBLIC_FACEBOOK_APP_ID}}
  NEXT_PUBLIC_WEATHER_API_KEY: ${{secrets.NEXT_PUBLIC_WEATHER_API_KEY}}
  NEXT_PUBLIC_HOST: ${{secrets.NEXT_PUBLIC_HOST}}
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  create-env:
    runs-on: ubuntu-20.04
    steps:
      - name: Make envfile
        uses: SpicyPizza/create-envfile@v1
        with:
          MONGODB_URI: ${{secrets.MONGODB_URI}}
          NEXT_PUBLIC_API_ENDPOINT: ${{secrets.NEXT_PUBLIC_API_ENDPOINT}}
          HOST: ${{secrets.HOST}}
          NEXT_PUBLIC_DOMAIN: ${{secrets.NEXT_PUBLIC_DOMAIN}}
          NEXT_PUBLIC_FACEBOOK_APP_ID: ${{secrets.NEXT_PUBLIC_FACEBOOK_APP_ID}}
          NEXT_PUBLIC_WEATHER_API_KEY: ${{secrets.NEXT_PUBLIC_WEATHER_API_KEY}}
          NEXT_PUBLIC_HOST: ${{secrets.NEXT_PUBLIC_HOST}}
          file_name: .env

  # This workflow contains a single job called "build"

  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    - name: Deploy using ssh
      uses: appleboy/ssh-action@master


      with:
        host: ${{ secrets.HOST }}
        key: ${{ secrets.KEY }}
        username: ${{ secrets.USERNAME }}
        # password: ${{ secrets.PASSWORD }}
        port: 22
        script: |
          cd thehawk-frontend
          sudo git pull origin master
          sudo git status
          sudo rm -rf .next

          sudo pnpm install --only=prod
          sudo pnpm run build
          pm2 restart thehawk-frontend